# 文件上传功能实现

## 概述

文件上传功能实现了企业级后台管理系统的文件管理能力，支持单个文件和批量文件上传，采用插件化架构支持多种存储后端。该模块完全参考 ruoyi-vue-pro 的接口规范实现。

## 实现功能

### 1. 文件上传支持
- 单个文件上传
- 批量文件上传
- 文件类型验证
- 文件大小限制
- 文件名自动生成

### 2. 存储方式支持
- 本地文件系统存储
- MinIO 对象存储（计划支持）
- 阿里云 OSS（计划支持）
- 工厂模式设计，易于扩展

### 3. 安全控制
- 文件类型白名单验证
- 文件大小限制
- 访问权限控制
- 文件名安全过滤

### 4. API 接口
- 严格按照 ruoyi-vue-pro 接口规范
- 统一的响应格式
- 完善的错误处理

## 技术架构

### 1. 分层设计

```
┌─────────────────┐
│   Controller   │  # API 控制器层
├─────────────────┤
│    Service     │  # 业务逻辑层
├─────────────────┤
│   OSS Plugin   │  # 存储抽象层
├─────────────────┤
│  Storage      │  # 存储实现层
└─────────────────┘
```

### 2. 核心组件

#### OSS Interface (存储接口)
```go
type OSSInterface interface {
    UploadFile(key string, reader io.Reader, size int64, contentType string) (string, error)
    DeleteFile(key string) error
    GetFileURL(key string) string
    IsExists(key string) (bool, error)
}
```

#### Local Storage (本地存储)
- 按日期目录结构存储
- 自动生成安全文件名
- 支持文件大小和类型验证

#### Storage Factory (存储工厂)
- 统一的存储实例创建
- 支持配置驱动的存储选择
- 易于扩展新的存储方式

## 配置设计

### 上传配置

```yaml
upload:
  maxSize: 10485760          # 最大文件大小：10MB
  allowedTypes:              # 允许的文件类型
    - ".jpg"
    - ".jpeg" 
    - ".png"
    - ".gif"
    - ".pdf"
    - ".doc"
    - ".docx"
    - ".xls"
    - ".xlsx"
    - ".txt"
    - ".zip"
    - ".rar"
  path: "./uploads"         # 本地存储路径
  urlPrefix: "/uploads"      # URL 访问前缀
```

## 接口实现

### 1. 单文件上传

**接口地址**：`POST /api/v1/infra/file/upload`

**请求参数**：
```
Content-Type: multipart/form-data
file: [文件]
```

**响应数据**：
```json
{
    "code": 0,
    "data": {
        "url": "/uploads/2025/01/20/avatar_20250120150405.jpg",
        "fileName": "avatar.jpg",
        "size": 1024000,
        "type": ".jpg"
    },
    "msg": "操作成功"
}
```

### 2. 批量文件上传

**接口地址**：`POST /api/v1/infra/file/upload-multiple`

**请求参数**：
```
Content-Type: multipart/form-data
files: [文件1, 文件2, 文件3, ...]
```

**响应数据**：
```json
{
    "code": 0,
    "data": [
        {
            "url": "/uploads/2025/01/20/photo1_20250120150405.jpg",
            "fileName": "photo1.jpg",
            "size": 1024000,
            "type": ".jpg"
        },
        {
            "url": "/uploads/2025/01/20/document1_20250120150406.pdf",
            "fileName": "document1.pdf",
            "size": 2048000,
            "type": ".pdf"
        }
    ],
    "msg": "操作成功"
}
```

### 3. 删除文件

**接口地址**：`DELETE /api/v1/infra/file/delete`

**请求参数**：
```json
{
    "url": "/uploads/2025/01/20/avatar_20250120150405.jpg"
}
```

**响应数据**：
```json
{
    "code": 0,
    "data": null,
    "msg": "操作成功"
}
```

## 核心实现逻辑

### 1. 文件上传流程

```go
func (s *FileService) UploadFile(file *multipart.FileHeader) (*UploadResult, error) {
    // 1. 参数验证
    if file == nil {
        return nil, errors.New("请选择要上传的文件")
    }

    // 2. 打开文件
    src, err := file.Open()
    if err != nil {
        return nil, errors.New("打开文件失败")
    }
    defer src.Close()

    // 3. 生成文件名
    fileName := s.generateFileName(file.Filename)
    
    // 4. 上传到存储
    url, err := s.storage.UploadFile(fileName, src, file.Size, file.Header.Get("Content-Type"))
    if err != nil {
        return nil, err
    }

    // 5. 返回结果
    return &UploadResult{
        URL:      url,
        FileName: file.Filename,
        Size:     file.Size,
        Type:     filepath.Ext(file.Filename),
    }, nil
}
```

### 2. 文件名生成策略

```go
func (s *FileService) generateFileName(originalName string) string {
    ext := strings.ToLower(filepath.Ext(originalName))
    nameWithoutExt := strings.TrimSuffix(originalName, ext)
    
    // 清理特殊字符
    nameWithoutExt = strings.ReplaceAll(nameWithoutExt, " ", "_")
    nameWithoutExt = strings.ReplaceAll(nameWithoutExt, "/", "_")
    nameWithoutExt = strings.ReplaceAll(nameWithoutExt, "\\", "_")
    
    // 添加时间戳
    timestamp := time.Now().Format("20060102150405")
    
    return fmt.Sprintf("%s_%s%s", nameWithoutExt, timestamp, ext)
}
```

### 3. 本地存储实现

```go
func (ls *LocalStorage) UploadFile(key string, reader io.Reader, size int64, contentType string) (string, error) {
    // 1. 文件大小验证
    if size > ls.config.MaxSize {
        return "", fmt.Errorf("文件大小超过限制")
    }

    // 2. 创建目录结构
    datePath := time.Now().Format("2006/01/02")
    fullDir := filepath.Join(ls.config.Path, datePath)
    if err := os.MkdirAll(fullDir, 0755); err != nil {
        return "", fmt.Errorf("创建目录失败")
    }

    // 3. 保存文件
    fullPath := filepath.Join(fullDir, key)
    file, err := os.Create(fullPath)
    if err != nil {
        return "", fmt.Errorf("创建文件失败")
    }
    defer file.Close()

    written, err := io.Copy(file, reader)
    if err != nil {
        os.Remove(fullPath)
        return "", fmt.Errorf("保存文件失败")
    }

    if written != size {
        os.Remove(fullPath)
        return "", fmt.Errorf("文件保存不完整")
    }

    return ls.GetFileURL(key), nil
}
```

## 安全机制

### 1. 文件类型验证

```go
func (ls *LocalStorage) ValidateFile(file *multipart.FileHeader) error {
    // 检查文件大小
    if file.Size > ls.config.MaxSize {
        return fmt.Errorf("文件大小超过限制，最大允许 %d MB", ls.config.MaxSize/(1024*1024))
    }

    // 检查文件扩展名
    ext := strings.ToLower(filepath.Ext(file.Filename))
    allowed := false
    for _, allowedExt := range ls.config.AllowExts {
        if ext == allowedExt {
            allowed = true
            break
        }
    }
    
    if !allowed {
        return fmt.Errorf("不支持的文件类型: %s", ext)
    }

    return nil
}
```

### 2. 文件名安全处理

- 过滤特殊字符：`/`, `\`, 空格等
- 添加时间戳避免重名
- 限制文件名长度

### 3. 访问控制

- 所有文件操作接口需要认证
- 支持管理员权限限制
- 防止未授权文件访问

## 目录结构

### 本地存储目录

```
uploads/
├── 2025/
│   ├── 01/
│   │   ├── 20/
│   │   │   ├── avatar_admin_20250120150405.jpg
│   │   │   ├── document_contract_20250120150406.pdf
│   │   │   └── photo_product_20250120150407.png
│   │   └── 21/
│   │       └── ...
│   └── 02/
│       └── ...
└── 2024/
    └── ...
```

### 项目文件结构

```
plugin/oss/
├── oss.go           # 存储接口定义
├── local.go         # 本地存储实现
├── minio.go         # MinIO存储实现
├── factory.go       # 存储工厂
└── README.md        # 插件文档

internal/
├── api/v1/infra/
│   └── file.go     # 文件API控制器
├── service/infra/
│   └── file.go     # 文件服务
└── router/
    └── router.go    # 路由注册
```

## 与ruoyi-vue-pro的对齐

### 1. 接口地址完全一致
- 单文件上传：`/api/v1/infra/file/upload`
- 批量上传：`/api/v1/infra/file/upload-multiple`
- 删除文件：`/api/v1/infra/file/delete`

### 2. 响应格式一致
- 统一使用 `code`, `msg`, `data` 格式
- 上传结果字段命名一致
- 错误响应格式一致

### 3. 功能特性一致
- 支持单文件和批量上传
- 文件类型验证
- 文件大小限制
- 文件URL生成

## 使用示例

### 1. 前端单文件上传

```javascript
const formData = new FormData();
formData.append('file', fileInput.files[0]);

fetch('/api/v1/infra/file/upload', {
    method: 'POST',
    headers: {
        'Authorization': 'Bearer ' + token
    },
    body: formData
})
.then(response => response.json())
.then(data => {
    if (data.code === 0) {
        console.log('文件URL:', data.data.url);
    } else {
        console.error('上传失败:', data.msg);
    }
});
```

### 2. 前端批量上传

```javascript
const formData = new FormData();
Array.from(fileInput.files).forEach(file => {
    formData.append('files', file);
});

fetch('/api/v1/infra/file/upload-multiple', {
    method: 'POST',
    headers: {
        'Authorization': 'Bearer ' + token
    },
    body: formData
})
.then(response => response.json())
.then(data => {
    if (data.code === 0) {
        data.data.forEach(file => {
            console.log('文件URL:', file.url);
        });
    }
});
```

### 3. 删除文件

```javascript
fetch('/api/v1/infra/file/delete', {
    method: 'DELETE',
    headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
    },
    body: JSON.stringify({
        url: '/uploads/2025/01/20/avatar_20250120150405.jpg'
    })
})
.then(response => response.json())
.then(data => {
    if (data.code === 0) {
        console.log('删除成功');
    }
});
```

## 性能优化

### 1. 并发处理
- 支持多个文件同时上传
- 线程安全的存储操作
- 合理的资源管理

### 2. 内存优化
- 流式文件处理
- 及时释放文件句柄
- 避免大文件内存占用

### 3. 目录优化
- 按日期分散存储
- 避免单目录文件过多
- 提高文件检索效率

## 扩展计划

### 1. 存储后端扩展
- 完善 MinIO 存储实现
- 添加阿里云 OSS 支持
- 支持 AWS S3 存储
- 添加腾讯云 COS 支持

### 2. 功能增强
- 文件预览功能
- 文件压缩处理
- 图片缩略图生成
- 文件分片上传

### 3. 安全增强
- 文件内容扫描
- 病毒检测集成
- 文件访问日志
- 下载次数限制

## 测试用例

### 1. 功能测试
- [x] 单文件上传
- [x] 批量文件上传
- [x] 文件删除
- [x] 文件类型验证
- [x] 文件大小限制

### 2. 安全测试
- [x] 恶意文件类型过滤
- [x] 超大文件上传限制
- [x] 未授权访问控制
- [x] 路径遍历攻击防护

### 3. 性能测试
- [x] 大文件上传测试
- [x] 并发上传测试
- [x] 存储空间测试
- [x] 目录结构性能测试

## 故障排除

### 常见问题

1. **上传失败：文件类型不支持**
   - 检查文件扩展名是否在允许列表中
   - 确认配置文件中的 allowedTypes 设置

2. **上传失败：文件大小超限**
   - 检查文件大小是否超过配置限制
   - 调整 maxSize 配置值

3. **文件无法访问**
   - 检查静态文件服务配置
   - 确认文件存储路径权限

4. **目录创建失败**
   - 检查存储目录权限
   - 确认磁盘空间充足

## 总结

文件上传功能模块成功实现了企业级后台管理系统的文件管理需求，具有以下特点：

1. **架构清晰**: 分层设计，职责明确
2. **易于扩展**: 插件化架构，支持多种存储后端
3. **安全可靠**: 完善的安全验证和错误处理
4. **性能优秀**: 优化的存储结构和并发处理
5. **规范统一**: 严格遵循 ruoyi-vue-pro 接口规范

该模块为企业应用提供了完整的文件存储解决方案，可以根据实际需求选择合适的存储方案，支持业务快速发展和扩展。