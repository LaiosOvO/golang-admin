# 角色管理模块实现

## 概述

角色管理模块是系统权限管理的核心组成部分，实现了基于角色的访问控制（RBAC）系统。本模块严格按照 ruoyi-vue-pro 的接口规范实现，提供完整的角色生命周期管理功能。

## 实现思路

### 1. 数据模型设计

角色模型基于 `system.Role` 结构体，包含以下核心字段：

```go
type Role struct {
    model.AuditModel
    Code      string `gorm:"size:100;not null;uniqueIndex" json:"code"`
    Name      string `gorm:"size:30;not null" json:"name"`
    Sort      int    `gorm:"default:0" json:"sort"`
    DataScope int    `gorm:"default:1" json:"dataScope"` // 数据权限范围
    Status    int    `gorm:"default:1" json:"status"`    // 启用状态
    Type      int    `gorm:"default:1" json:"type"`      // 角色类型
    Remark    string `gorm:"size:500" json:"remark"`
    
    // 关联关系
    Users []User `gorm:"many2many:user_role;" json:"users,omitempty"`
    Menus []Menu `gorm:"many2many:role_menu;" json:"menus,omitempty"`
}
```

**数据权限范围说明：**
- 1: 全部数据权限
- 2: 自定义数据权限  
- 3: 本部门数据权限
- 4: 本部门及以下数据权限
- 5: 仅本人数据权限

**角色类型说明：**
- 1: 内置角色（不可删除）
- 2: 自定义角色

### 2. 分层架构实现

#### 2.1 DAO 层（数据访问层）

**文件位置：** `internal/dao/system/role.go`

**核心功能：**
- 角色分页查询
- 角色CRUD操作
- 角色菜单权限管理
- 数据唯一性校验

**关键实现：**
```go
// 分页查询示例
func (r *RoleDAO) GetPage(req *RolePageReq) ([]*RolePageResp, int64, error) {
    var roles []*system.Role
    var total int64

    db := r.db.Model(&system.Role{})
    
    // 动态查询条件
    if req.Name != "" {
        db = db.Where("name LIKE ?", "%"+req.Name+"%")
    }
    if req.Code != "" {
        db = db.Where("code LIKE ?", "%"+req.Code+"%")
    }
    
    // 分页查询
    offset := (req.PageNo - 1) * req.PageSize
    if err := db.Offset(offset).Limit(req.PageSize).Order("sort ASC, created_at DESC").Find(&roles).Error; err != nil {
        return nil, 0, err
    }
    
    return resps, total, nil
}
```

#### 2.2 Service 层（业务逻辑层）

**文件位置：** `internal/service/system/role.go`

**核心功能：**
- 业务逻辑封装
- 数据验证和业务规则检查
- 事务管理
- 错误处理

**关键实现：**
```go
// 创建角色示例
func (rs *RoleService) Create(req *system.RoleCreateReq, createBy uint) error {
    // 检查角色代码是否已存在
    exists, err := rs.roleDAO.CheckCodeExists(req.Code, nil)
    if err != nil {
        return err
    }
    if exists {
        return ErrRoleCodeExists
    }

    // 验证数据权限范围
    if !rs.isValidDataScope(req.DataScope) {
        return ErrInvalidDataScope
    }

    return rs.roleDAO.Create(req, createBy)
}
```

#### 2.3 Controller 层（API控制器层）

**文件位置：** `internal/api/v1/system/role.go`

**核心功能：**
- HTTP请求处理
- 参数验证
- 响应格式化
- 错误码映射

**关键实现：**
```go
// 创建角色接口示例
func (ctrl *RoleController) Create(c *gin.Context) {
    var req system.RoleCreateReq
    if err := c.ShouldBindJSON(&req); err != nil {
        response.BadRequest(c, "参数错误："+err.Error())
        return
    }

    // 获取当前操作用户ID
    userID, exists := c.Get("userId")
    if !exists {
        response.Unauthorized(c, "未获取到用户信息")
        return
    }

    err := ctrl.roleService.Create(&req, userID.(uint))
    if err != nil {
        if err == roleservice.ErrRoleCodeExists {
            response.BadRequest(c, "角色代码已存在")
            return
        }
        response.Error(c, "创建失败："+err.Error())
        return
    }

    response.Success(c, nil)
}
```

### 3. 接口规范

严格按照 ruoyi-vue-pro 接口规范实现：

| 接口地址 | 方法 | 功能 | 权限要求 |
|---------|------|------|----------|
| `/api/v1/system/role/page` | GET | 角色分页查询 | 需要认证 |
| `/api/v1/system/role/get` | GET | 获取角色详情 | 需要认证 |
| `/api/v1/system/role/create` | POST | 创建角色 | 需要认证+管理员权限 |
| `/api/v1/system/role/update` | PUT | 更新角色 | 需要认证+管理员权限 |
| `/api/v1/system/role/delete` | DELETE | 删除角色 | 需要认证+管理员权限 |
| `/api/v1/system/role/list-all-simple` | GET | 角色精简列表 | 需要认证 |
| `/api/v1/system/role/assign-menu/:roleId` | PUT | 分配菜单权限 | 需要认证+管理员权限 |
| `/api/v1/system/role/menu-permissions/:roleId` | GET | 获取菜单权限 | 需要认证 |

### 4. 权限管理

#### 4.1 菜单权限分配

实现了角色与菜单的多对多关联管理：

```go
// 分配菜单权限
func (rs *RoleService) AssignMenuPermissions(roleID uint, menuIDs []uint) error {
    return rs.roleDAO.AssignMenuPermissions(roleID, menuIDs)
}

// 获取角色菜单权限
func (rs *RoleService) GetMenuPermissions(roleID uint) ([]uint, error) {
    return rs.roleDAO.GetMenuIDsByRoleID(roleID)
}
```

#### 4.2 数据权限配置

支持5种数据权限范围配置，为后续数据权限控制提供基础。

### 5. 路由集成

在 `internal/router/router.go` 中集成角色管理路由：

```go
// 角色管理路由
role := system.Group("/role")
role.Use(middleware.Auth()) // 认证中间件
{
    role.GET("/page", roleCtrl.Page)
    role.GET("/get", roleCtrl.Get)
    role.POST("/create", middleware.AdminOnly(), roleCtrl.Create)
    role.PUT("/update", middleware.AdminOnly(), roleCtrl.Update)
    role.DELETE("/delete", middleware.AdminOnly(), roleCtrl.Delete)
    role.GET("/list-all-simple", roleCtrl.ListAllSimple)
    role.PUT("/assign-menu/:roleId", middleware.AdminOnly(), roleCtrl.AssignMenuPermissions)
    role.GET("/menu-permissions/:roleId", roleCtrl.GetMenuPermissions)
}
```

### 6. 错误处理

定义了专门的错误类型：

```go
var (
    ErrRoleNotFound       = errors.New("角色不存在")
    ErrRoleCodeExists     = errors.New("角色代码已存在")
    ErrRoleHasUsers       = errors.New("角色下存在用户，无法删除")
    ErrRoleIsBuiltin      = errors.New("内置角色，无法删除")
    ErrInvalidDataScope   = errors.New("无效的数据权限范围")
)
```

### 7. 服务容器集成

在服务容器中添加MySQL客户端支持，确保数据库连接正常：

```go
// ServiceContainer 服务容器
type ServiceContainer struct {
    TokenService *token.TokenService
    RedisClient  *redis.Client
    MySQLClient  *mysql.Client  // 新增MySQL客户端
}
```

## 技术特点

### 1. 严格遵循项目规范
- 完全按照 ruoyi-vue-pro 接口规范
- 统一的响应格式和错误处理
- 完整的Swagger文档注释

### 2. 完善的权限控制
- 基于中间件的认证和授权
- 管理员权限验证
- 数据权限范围配置

### 3. 高质量的代码
- 分层架构，职责清晰
- 完善的错误处理
- 数据验证和业务规则检查

### 4. 易于扩展
- 支持多种数据权限范围
- 灵活的菜单权限分配
- 预留扩展点

## 使用示例

### 1. 创建角色

```json
POST /api/v1/system/role/create
{
    "code": "project_manager",
    "name": "项目经理",
    "sort": 2,
    "dataScope": 3,
    "status": 1,
    "type": 2,
    "remark": "负责项目管理"
}
```

### 2. 分配菜单权限

```json
PUT /api/v1/system/role/assign-menu/1
{
    "ids": [1, 2, 3, 10, 11]
}
```

### 3. 查询角色列表

```json
GET /api/v1/system/role/page?pageNo=1&pageSize=10&name=项目
```

## 测试要点

1. **功能测试**：验证所有CRUD操作正常
2. **权限测试**：验证权限控制机制有效
3. **数据验证测试**：验证数据唯一性和业务规则
4. **边界测试**：测试各种边界情况
5. **性能测试**：验证分页查询性能

## 后续优化

1. **用户关联检查**：删除角色前检查是否有关联用户
2. **数据权限实现**：基于角色数据范围的实际数据过滤
3. **缓存优化**：角色信息缓存机制
4. **操作日志**：角色操作的详细日志记录

角色管理模块的成功实现为整个权限系统奠定了坚实基础，后续的菜单管理、部门管理等模块可以在此基础上顺利构建。