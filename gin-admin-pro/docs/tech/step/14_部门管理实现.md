# 部门管理实现

## 功能概述

部门管理模块实现了完整的树形部门组织架构管理功能，支持多级部门嵌套、部门负责人设置、用户归属查询等功能。完全参考 ruoyi-vue-pro 的接口规范实现。

## 技术实现

### 1. 数据模型设计

#### Dept 模型结构
```go
type Dept struct {
    model.TreeModel           // 继承树形结构模型
    LeaderUserId uint          // 负责人用户ID
    Phone        string        // 联系电话
    Email        string        // 联系邮箱
    Status       int           // 状态：0-禁用 1-启用
    Parent       *Dept         // 父部门关联
    Children     []Dept        // 子部门关联
    Leader       *User         // 负责人关联
    Users        []User        // 部门用户关联
}
```

#### TreeModel 基础模型
```go
type TreeModel struct {
    AuditModel                      // 审计模型
    ParentID  uint                  // 父级ID
    Level     int                   // 层级
    Sort      int                   // 排序
    Name      string                // 名称
    Path      string                // 路径
    Ancestors string                // 祖先路径（逗号分隔的ID链）
}
```

### 2. 数据库表结构

#### system_dept 表
- `id`: 主键
- `parent_id`: 父部门ID
- `level`: 层级（从1开始）
- `sort`: 同级排序
- `name`: 部门名称
- `path`: 路径（用于层级展示）
- `leader_user_id`: 负责人用户ID
- `phone`: 联系电话
- `email`: 联系邮箱
- `status`: 状态（0-禁用 1-启用）
- `ancestors`: 祖先路径，用于快速查询
- 审计字段：`create_by`, `update_by`, `remark`, `created_at`, `updated_at`, `deleted_at`

### 3. 核心功能实现

#### 3.1 DAO层实现

**树形结构构建**
```go
func (dao *DeptDAO) buildDeptTree(depts []system.Dept, parentID uint) []DeptResp {
    var tree []DeptResp
    
    for _, dept := range depts {
        if dept.ParentID == parentID {
            node := DeptResp{
                ID:         dept.ID,
                Name:       dept.Name,
                Leader:     dept.LeaderUserId,
                Phone:      dept.Phone,
                Email:      dept.Email,
                Status:     dept.Status,
                // ... 其他字段映射
            }
            
            // 设置负责人姓名
            if dept.Leader != nil {
                node.LeaderName = dept.Leader.Nickname
            }
            
            // 递归构建子部门
            children := dao.buildDeptTree(depts, dept.ID)
            if len(children) > 0 {
                node.Children = children
            }
            tree = append(tree, node)
        }
    }
    return tree
}
```

**部门用户查询**
```go
func (dao *DeptDAO) GetUsersByDept(deptID uint) ([]system.User, error) {
    var users []system.User
    err := dao.db.Model(&system.User{}).
        Preload("Dept").
        Where("dept_id = ? AND status = ?", deptID, 1).
        Find(&users).Error
    
    return users, err
}
```

#### 3.2 Service层实现

**删除前置检查**
```go
func (s *DeptService) Delete(id uint) error {
    // 检查是否有子部门
    var count int64
    if err := s.deptDAO.db.Model(&system.Dept{}).
        Where("parent_id = ?", id).Count(&count).Error; err != nil {
        return err
    }
    if count > 0 {
        return errors.New("部门存在子部门，无法删除")
    }

    // 检查部门下是否有用户
    var userCount int64
    if err := s.deptDAO.db.Model(&system.User{}).
        Where("dept_id = ?", id).Count(&userCount).Error; err != nil {
        return err
    }
    if userCount > 0 {
        return errors.New("部门下存在用户，无法删除")
    }

    return s.deptDAO.Delete(id)
}
```

**循环引用检查**
```go
func (s *DeptService) checkCircularReference(deptID, parentID uint) error {
    parentChain, err := s.deptDAO.GetParentChain(parentID)
    if err != nil {
        return err
    }
    
    for _, parent := range parentChain {
        if parent.ID == deptID {
            return errors.New("不能将部门设置为自己的子部门，会造成循环引用")
        }
    }
    return nil
}
```

#### 3.3 API层实现

**控制器结构**
```go
type DeptController struct {
    deptService *deptservice.DeptService
}
```

**路由注册**
```go
dept := system.Group("/dept")
dept.Use(middleware.Auth()) // 认证中间件
{
    dept.GET("/list", deptCtrl.List)                                    // 部门列表
    dept.GET("/get", deptCtrl.Get)                                      // 部门详情
    dept.POST("/create", middleware.AdminOnly(), deptCtrl.Create)       // 创建部门（仅管理员）
    dept.PUT("/update", middleware.AdminOnly(), deptCtrl.Update)        // 更新部门（仅管理员）
    dept.DELETE("/delete", middleware.AdminOnly(), deptCtrl.Delete)     // 删除部门（仅管理员）
    dept.GET("/list-all-simple", deptCtrl.ListAllSimple)                // 部门精简列表
    dept.GET("/users", deptCtrl.GetUsers)                               // 部门用户列表
}
```

### 4. 接口规范

#### 4.1 部门列表
- **路径**: `GET /api/v1/system/dept/list`
- **参数**: 
  - `name` (string, 可选): 部门名称模糊查询
  - `status` (int, 可选): 状态筛选
- **响应**: 树形结构的部门数组，包含负责人信息

#### 4.2 创建部门
- **路径**: `POST /api/v1/system/dept/create`
- **权限**: 仅管理员
- **请求体**: 
```json
{
    "parentId": 1,
    "name": "测试部门",
    "sort": 10,
    "leader": 1,
    "phone": "13800138000",
    "email": "test@example.com",
    "status": 1,
    "remark": "测试部门"
}
```

#### 4.3 部门用户查询
- **路径**: `GET /api/v1/system/dept/users`
- **权限**: 需要认证
- **参数**: `deptId` (int, 必填): 部门ID
- **响应**: 部门下的用户列表

### 5. 核心特性

#### 5.1 树形结构支持
- 支持无限级部门嵌套
- 自动计算层级和祖先路径
- 递归构建树形结构响应
- 支持部门迁移和层级调整

#### 5.2 负责人管理
- 支持设置部门负责人
- 自动加载负责人信息
- 支持负责人变更

#### 5.3 数据完整性
- 循环引用检查
- 同级部门名称唯一性
- 删除前置条件检查（有子部门或用户时无法删除）
- 部门用户关联完整性

#### 5.4 业务关联
- 用户归属部门管理
- 部门用户查询
- 数据权限范围控制基础

### 6. 安全考虑

#### 6.1 权限验证
- 所有部门管理接口需要认证
- 创建/更新/删除操作仅限管理员
- 部门用户查询需要认证

#### 6.2 数据验证
- 部门名称唯一性验证
- 负责人有效性验证（可扩展）
- 循环引用防护

#### 6.3 业务规则
- 有子部门时不能删除
- 有用户时不能删除
- 支持部门禁用而不删除

### 7. 性能优化

#### 7.1 数据库优化
- 祖先路径字段支持快速查询
- 合理的索引设计
- 预加载关联数据

#### 7.2 查询优化
- 批量查询减少数据库访问
- 树形结构构建算法优化
- 分页查询支持（可选）

### 8. 测试用例

#### 8.1 基础CRUD测试
- 创建多级部门
- 更新部门信息
- 删除部门（包括有子部门/用户的情况）

#### 8.2 树形结构测试
- 多级部门创建
- 部门移动操作
- 循环引用防护

#### 8.3 关联测试
- 部门用户查询
- 负责人设置和查询
- 用户部门关联

### 9. 与ruoyi-vue-pro的对齐

#### 9.1 接口地址完全一致
- 部门列表：`/api/v1/system/dept/list`
- 部门详情：`/api/v1/system/dept/get`
- 创建部门：`/api/v1/system/dept/create`
- 更新部门：`/api/v1/system/dept/update`
- 删除部门：`/api/v1/system/dept/delete`
- 简单列表：`/api/v1/system/dept/list-all-simple`
- 部门用户：`/api/v1/system/dept/users`

#### 9.2 响应格式一致
- 统一使用 `code`, `msg`, `data` 格式
- 树形结构字段命名一致
- 负责人信息格式一致

#### 9.3 业务逻辑一致
- 部门层级管理逻辑一致
- 删除前置条件一致
- 权限控制逻辑一致

### 10. 未来扩展

#### 10.1 功能扩展
- 部门成本中心管理
- 部门预算管理
- 部门绩效统计

#### 10.2 数据权限
- 基于部门的数据权限控制
- 部门数据隔离
- 跨部门数据访问控制

#### 10.3 组织架构
- 支持虚拟组织
- 项目团队管理
- 矩阵式组织结构

### 11. 集成关系

#### 11.1 与用户管理集成
- 用户归属部门设置
- 部门用户列表查询
- 用户部门变更

#### 11.2 与角色权限集成
- 基于部门的数据权限
- 部门管理员角色
- 跨部门权限控制

#### 11.3 与工作流集成
- 部门审批流程
- 跨部门协作流程
- 组织架构变更审批

## 总结

部门管理模块成功实现了企业级后台管理系统的组织架构管理功能，采用树形结构设计支持无限级部门嵌套，通过负责人设置和用户关联实现完整的组织管理。接口完全对齐ruoyi-vue-pro规范，具备良好的扩展性和安全性，为数据权限控制和组织管理提供了坚实的基础。