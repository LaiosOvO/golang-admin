# 用户管理模块实现

## 概述

用户管理模块是系统的核心模块之一，实现了完整的用户CRUD操作、认证授权、密码管理等功能。严格按照ruoyi-vue-pro的接口规范进行设计。

## 实现思路

### 1. 分层架构设计

采用典型的三层架构模式：

```
Controller (API层) -> Service (业务逻辑层) -> DAO (数据访问层)
```

- **Controller层**: 处理HTTP请求，参数验证，调用Service层
- **Service层**: 处理业务逻辑，事务管理，错误处理  
- **DAO层**: 数据库操作，SQL查询，数据转换

### 2. 数据模型设计

#### 用户表 (system_user)
```go
type User struct {
    model.AuditModel          // 继承基础审计字段
    Username  string          // 用户名，唯一索引
    Nickname  string          // 昵称
    Password  string          // 密码（加密存储）
    Mobile    string          // 手机号
    Email     string          // 邮箱
    Avatar    string          // 头像URL
    Status    int             // 状态：0-禁用 1-启用
    LoginIP   string          // 最后登录IP
    LoginDate *gorm.DeletedAt // 最后登录时间
    DeptID    uint            // 部门ID
    Dept      *Dept           // 关联部门
    PostIDs   string          // 岗位ID列表（逗号分隔）
    Posts     []Post          // 多对多关联岗位
    Roles     []Role          // 多对多关联角色
}
```

### 3. 核心功能实现

#### 3.1 用户认证流程

```
用户登录 -> 验证用户名密码 -> 生成JWT Token -> 更新登录信息 -> 返回Token
```

**关键特性**:
- 密码使用bcrypt加密存储
- JWT Token支持访问令牌和刷新令牌
- Token存储在Redis中，支持撤销和单点登录
- 记录登录IP和时间

#### 3.2 密码安全处理

```go
// 密码加密
hashedPassword, err := bcrypt.GenerateFromPassword([]byte(password), bcrypt.DefaultCost)

// 密码验证
err := bcrypt.CompareHashAndPassword([]byte(hashedPassword), []byte(password))
```

**安全特性**:
- 使用bcrypt算法，自动加盐
- 默认cost值为12，安全性高
- 每次加密结果不同，防止彩虹表攻击

#### 3.3 用户状态管理

支持两种用户状态：
- **1**: 启用状态，可以正常登录
- **0**: 禁用状态，无法登录系统

状态修改记录操作人信息，支持审计追踪。

#### 3.4 数据唯一性校验

在创建和更新用户时，严格校验：
- 用户名唯一性
- 邮箱唯一性（如果提供）
- 手机号唯一性（如果提供）

## 接口实现

### 1. 用户管理接口

| 接口路径 | 方法 | 说明 |
|---------|------|------|
| `/api/v1/system/user/page` | GET | 分页查询用户列表 |
| `/api/v1/system/user/get` | GET | 获取用户详情 |
| `/api/v1/system/user/create` | POST | 创建用户 |
| `/api/v1/system/user/update` | PUT | 更新用户 |
| `/api/v1/system/user/delete` | DELETE | 删除用户 |
| `/api/v1/system/user/delete-list` | DELETE | 批量删除用户 |
| `/api/v1/system/user/update-password` | PUT | 重置用户密码 |
| `/api/v1/system/user/update-status` | PUT | 修改用户状态 |
| `/api/v1/system/user/simple-list` | GET | 获取用户简单列表 |

### 2. 认证接口

| 接口路径 | 方法 | 说明 |
|---------|------|------|
| `/api/v1/system/auth/login` | POST | 用户登录 |
| `/api/v1/system/auth/logout` | POST | 用户登出 |
| `/api/v1/system/auth/refresh-token` | POST | 刷新Token |
| `/api/v1/system/auth/get-permission-info` | GET | 获取用户权限信息 |

## 错误处理

### 业务错误定义

```go
var (
    ErrUserNotFound       = errors.New("用户不存在")
    ErrUsernameExists      = errors.New("用户名已存在")
    ErrEmailExists         = errors.New("邮箱已存在")
    ErrMobileExists        = errors.New("手机号已存在")
    ErrPasswordIncorrect   = errors.New("密码错误")
    ErrUserDisabled        = errors.New("用户已被禁用")
    ErrInvalidCredentials  = errors.New("用户名或密码错误")
)
```

### HTTP状态码映射

| 错误类型 | HTTP状态码 | 业务场景 |
|---------|-----------|----------|
| 参数错误 | 400 | 请求参数验证失败 |
| 认证失败 | 401 | Token无效或过期 |
| 权限不足 | 403 | 用户被禁用或无权限 |
| 资源不存在 | 404 | 用户不存在 |
| 服务器错误 | 500 | 系统内部错误 |

## 数据库事务

所有涉及多表操作的功能都使用数据库事务：

1. **创建用户**: 用户信息 + 岗位关联
2. **更新用户**: 用户信息 + 岗位关联更新
3. **删除用户**: 软删除用户记录

事务回滚机制确保数据一致性。

## 安全特性

### 1. 密码安全
- bcrypt加密存储
- 前端传输HTTPS加密
- 后端不记录明文密码

### 2. 认证安全
- JWT Token有效期控制
- Token黑名单机制
- 刷新Token轮换

### 3. 接口安全
- 参数绑定验证
- SQL注入防护（GORM）
- XSS防护（输出转义）

## 测试建议

### 1. 单元测试覆盖
- [ ] Service层业务逻辑测试
- [ ] DAO层数据操作测试
- [ ] 密码加密解密测试
- [ ] 唯一性校验测试

### 2. 集成测试
- [ ] 用户注册登录流程
- [ ] Token刷新机制
- [ ] 权限验证流程
- [ ] 并发操作测试

### 3. 性能测试
- [ ] 大量用户分页查询
- [ ] 批量用户操作
- [ ] 高并发登录测试

## 部署注意事项

### 1. 数据库
- 确保用户表已创建
- 添加必要索引（username唯一索引）
- 初始化默认管理员用户

### 2. Redis
- Token存储需要Redis服务
- 配置合适的过期时间
- 监控Redis内存使用

### 3. JWT配置
- 配置安全的密钥
- 设置合理的Token有效期
- 启用Token刷新机制

## 与ruoyi-vue-pro对应关系

| 功能模块 | ruoyi-vue-pro | gin-admin-pro |
|---------|---------------|---------------|
| 用户分页查询 | `/system/user/page` | `/api/v1/system/user/page` |
| 用户详情 | `/system/user/get` | `/api/v1/system/user/get` |
| 创建用户 | `/system/user/create` | `/api/v1/system/user/create` |
| 用户登录 | `/system/auth/login` | `/api/v1/system/auth/login` |
| 权限信息 | `/system/auth/get-permission-info` | `/api/v1/system/auth/get-permission-info` |

接口完全兼容ruoyi-vue-pro的响应格式，前端可直接复用。

## 后续优化方向

1. **功能增强**
   - 用户导入导出功能
   - 用户头像上传
   - 登录日志记录

2. **性能优化**
   - 查询结果缓存
   - 批量操作优化
   - 分页查询优化

3. **安全增强**
   - 多因素认证
   - 登录设备管理
   - 异常登录检测

## 文件结构

```
internal/
├── api/v1/system/
│   └── user.go              # 用户控制器
├── service/system/
│   └── user.go              # 用户服务
├── dao/system/
│   └── user.go              # 用户数据访问
├── model/system/
│   └── system.go            # 用户模型
└── pkg/
    ├── response/response.go  # 统一响应
    └── page.go             # 分页模型
```

整个用户管理模块设计遵循了企业级应用的最佳实践，具备良好的可扩展性和维护性。